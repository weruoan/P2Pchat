# Защищённый чат с использованием ECDH и AES

Этот проект реализует защищённый чат с клиент-серверной архитектурой, где сообщения шифруются с использованием симметричного ключа AES, а ключ сессии распространяется создателем комнаты с помощью ECDH (Diffie-Hellman на эллиптических кривях). Доступ к комнате защищён паролем, а сервер обеспечивает передачу зашифрованных данных между клиентами.

## Особенности
- **Шифрование сообщений**: Все сообщения шифруются с помощью AES (CBC, PKCS7 padding) с использованием 256-битного сессионного ключа.
- **ECDH для распространения ключа**: Создатель комнаты генерирует сессионный ключ и шифрует его для каждого пользователя с использованием их публичного ключа ECDH.
- **Защита паролем**: Доступ к комнате возможен только при правильном хэше пароля (SHA256).
- **Автоматическое обновление**: Клиентский интерфейс (Streamlit) обновляется каждые 2 секунды для получения новых сообщений и пользователей.
- **Безопасность**: Публичные ключи ECDH доступны только пользователям, знающим пароль комнаты.

## Требования
- Python 3.8+
- Зависимости:
  - `fastapi`
  - `uvicorn`
  - `requests`
  - `streamlit`
  - `cryptography`

Установите зависимости с помощью:
```bash
pip install fastapi uvicorn requests streamlit cryptography
```

## Структура проекта
- `server.py`: Сервер на FastAPI, который управляет комнатами, пользователями, зашифрованными сообщениями и сессионными ключами.
- `client.py`: Клиент на Streamlit, предоставляющий пользовательский интерфейс для подключения к комнате, отправки и получения сообщений.

## Установка и запуск
1. **Клонируйте репозиторий**:
   ```bash
   git clone https://github.com/weruoan/P2Pchat.git
   cd P2Pchat
   ```

2. **Запустите сервер**:
   ```bash
   uvicorn server:app --host 0.0.0.0 --port 8000
   ```

3. **Запустите клиент**:
   ```bash
   streamlit run client.py
   ```

4. **Использование**:
   - Откройте клиентский интерфейс в браузере (обычно `http://localhost:8501`).
   - Введите IP сервера (например, `127.0.0.1`), имя пользователя, ID чата и пароль.
   - Первый пользователь становится создателем комнаты и генерирует сессионный ключ.
   - Другие пользователи подключаются, вводя тот же ID чата и пароль, и получают зашифрованный сессионный ключ от создателя.
   - Сообщения шифруются и отображаются в реальном времени.

## Технические детали
- **Шифрование**:
  - Сессионный ключ (256 бит) генерируется создателем комнаты и шифруется для каждого пользователя с использованием общего секрета ECDH (кривые SECP256R1).
  - Сообщения шифруются с помощью AES в режиме CBC с PKCS7 padding.
- **API сервера**:
  - `/register`: Регистрирует пользователя в комнате, возвращает статус и публичный ключ ECDH создателя.
  - `/set_session_key`: Позволяет создателю устанавливать зашифрованный сессионный ключ для пользователей.
  - `/send_message`: Сохраняет зашифрованные сообщения.
  - `/get_updates`: Возвращает новые сообщения, список пользователей и зашифрованный сессионный ключ.
  - `/get_public_keys`: Возвращает публичные ключи ECDH пользователей (только для тех, кто знает пароль комнаты).
- **Безопасность**:
  - Доступ к публичным ключам и комнате защищён хэшем пароля (SHA256).
  - Сервер не имеет доступа к plaintext сообщений или сессионному ключу.
  - Приватные ключи ECDH хранятся только на клиенте.

## Ограничения
- Создатель комнаты должен быть активен, чтобы зашифровать сессионный ключ для новых пользователей.
- Отсутствует ротация сессионных ключей (можно добавить для production).
- Для production рекомендуется использовать HTTPS для защиты от атак на канале связи.

## Возможные улучшения
- Добавить ротацию сессионных ключей для повышения безопасности.
- Реализовать механизм хранения зашифрованного ключа на сервере для оффлайн-доступа новых пользователей.
- Добавить поддержку уведомлений о новых сообщениях через WebSocket.
- Внедрить механизм повторной попытки при сетевых ошибках.

## Лицензия
MIT License. См. файл `LICENSE` для подробностей.
